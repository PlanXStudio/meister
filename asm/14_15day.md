# IoT 통합 솔루션 for 마이크로컨트롤러
## 실습환경
- PC와 실습장치(이하 Auto 제어기)를 USB 케이블(A to microB)로 연결 (시리얼 통신)
  - Auto 제어기에는 고성능 마이크로컨트롤러(Cortex-M4)와 Zigbee 모뎀(저전력 개인무선통신), 릴레이, PWM 컨트롤러, 터미널 포트 등이 포함되어 있음
  - 마이크로파이썬(마이크로컨트롤러를 위한 파이썬 축소 버전)으로 동작
- 케이블링 (수행평가 항목임!)
  - Auto 제어기에 12V DC 전원 어댑터 연결
  - USB 허브에 5V DC 전원 어댑터 연결(마이크로USB B 커넥터)
    - 전용 데이터 케이블을 PC에 연결 (전용 포트)
  - FAN을 릴레이 채널3에 연결 (O, GND)
  - 전등을 릴레이 채널2에 연결 (O, GND)
  - 도어락을 릴레이 채널1에 연결 (C, O)
    
## Auto 제어기 제어 명령
- VSCode의 터미널창에서 진행

**시리얼 포트 찾기**
- Auto 제어기를 USB 허브에 연결하지 않은 상태에서 실행
```sh
xnode scan
```
- Auto 제어기를 USB 허브에 연결 한 후 실행 
```sh
xnode scan
```
- Auto 제어기에 할당된 자신의 포트 번호는 몇 번인가?

** Auto 제어기에서 스크립트 파일 실행**
```sh
xnode -p<포트이름> run <스크립트파일명>
```
> 스크립트가 끝날 때까지 시리얼 출력을 기다림

- 추가 옵션
  - -n: 시리얼 출력을 기다리지 않으므로 PC 쪽에서는 프로그램이 종료한 것처럼 보임 
    - 스크립트는 Auto 제어기에서 계속 실행됨
  - -ni (또는 -n -i): -i와 같으나 누른 키를 터미널 창에 표시하지 않음 (Echo off)

<br>

---

<br>


## IoT 프로그래밍
### 마이크로컨트롤러를 위한 Processing 프로그래밍 구조
> 프로세싱은 예술가를 위해 언어로 멀티미디어 프로그래밍에 사용되었으며 Arduino도 이 구조를 채택함

```python
from time import sleep
from pop import Uart

uart = None

def setup():
    uart = Uart()
    uart.write("Starting...\n")

def loop():
    uart.write("Loop...\n")
    sleep(1)

def main():
    setup()
    while True:
        loop()
        sleep(0.01)

if __name__ == "__main__":
    main()
```

**코드 실행**
```sh
xnode scan
```
```
xnode -p<포트번호> run <스크립트파일명>
```

**실행 종료**
- [방법1] 키보드 인터럽트로 통신 종료
  - \<CTRL\> + c
- [방법2] 시리얼 통신 강제로 종료
  - USB 케이블 분리 후 다시 연결
- [방법3] 실행 중인 스크립트 코드 강제 종료
  - Auto 제어기 전원 분리 후 다시 연결

**다음 질문에 답하시오.**
- from ~ import 문장의 의미는 무엇인가? 
- 함수란 무엇인가?
- setup() 함수의 역할은 무엇인가?
- loop() 함수의 역할은 무엇인가?
- setup()과 loop() 함수에서 공유할 객체는 어떻게 사용하는가?
- main() 함수에 포함된 while True: 문장의 의미는 무엇인가?
- [심화] main() 함수의 while 루프에서 sleep()을 사용하는 이유는 무엇인가?

### UART 송수신 처리
- Uart 클래스의 객체를 만든 후 데이터 송수신
  - read(): Auto 제어기가 수신한 데이터 읽기
  - write(): Auto 제어기에서 PC로 데이터 쓰기
    - print() 함수로 대체 가능

```python
from time import sleep
from pop import Uart

uart = None

def setup():
    global uart
    uart = Uart()
    uart.write("Starting...\n")

def loop():
    oneByte = uart.read(1)
    uart.write("> %s\n"%(oneByte)) # print("> %s\n"%(oneByte))

def main():
    setup()
    while True:
        loop()
        sleep(0.01)

if __name__ == "__main__":
    main()
```

**실행**
- 펌웨어 실행 중에도 시리얼 케이블을 통해 PC쪽 키보드 입력이 Auto 제어기로 전달됨
  ```sh
  xnode -p<포트번호> run <스크립트파일명>
  ```

**다음 질문에 답하시오.**
- PC에서 데이터를 전송하지 않으면 어떻게 되는가?
- PC에서 전송한 a 키의 수신 결과는 무엇인가?
- PC에서 전송한 A 키의 수신 결과는 무엇인가?
- PC에서 전송한 \<TAB\> 키의 수신 결과는 무엇인가?
- PC에서 전송한  \<SPACE\> 키의 수신 결과는 무엇인가?
- PC에서 전송한 \<BACKSPACE\> 키의 수신 결과는 무엇인가?
- PC에서 전송한 \<ENTER\> 키의 수신 결과는 무엇인가?
- [심화] 바이트 문자열과 파이썬 문자열의 차이점은 무엇인가?
  - b'Hello" VS 'Hello'

### UART 줄 단위 수신 함수(readLine()) 구현
- 줄 단위 수신은 1바이트씩 \<ENTER\> 전까지 누적해 읽음

```python
EOL_R = b'\r' #[참고] 키보드 입력이 아니라면 b'\n'으로 변경 가능

def readLine():
    buffer = ""
    while True:
        oneByte = uart.read(1)
        
        if oneByte == EOL_R:
            return buffer
        else:
            buffer += oneByte.decode()
```

**다음 질문에 답하시오.**
- readLine() 함수를 정의하는 이유는 무엇인가? 
- readLine() 함수는 왜 1바이트씩 읽어 처리하는가?
- Uart() 객체의 read() 메소드로 읽은 데이터를 decode()로 변환하는 이유는 무엇인가?

### UART 줄 단위 송신 함수(writeLine()) 구현
- 송신할 문자열 끝에 <ENTER>를 추가해 write() 메소드에 전달
  - write() 메소드에 문자열을 전달하면 UART 객체는 내부에서 이를 바이트 문자열로 바꿔 송신

```python
EOL_W = '\n'

def writeLine(buffer):
    buffer += EOL_W
    uart.write(buffer)
```

**다음 질문에 답하시오.**
- write() 메소드는 왜 전달받은 파이썬 문자열을 바이트 문자열로 바꿔 송신하는가?
- 문자열 끝에 줄바꿈 문자를 추가해 전송하면 어떤 장점이 있는가? 

### 시리얼 통신 루프백(loopback) 테스트 스크립트
- PC에서 줄 단위로 전달한 문자열(\<ENTER\>로 종료)을 Auto 제어가 PC에 다시 전송함

```python
from time import sleep
from pop import Uart

EOL_R = b'\r'
EOL_W = '\n'

uart = None

def readLine():
    buffer = ""
    while True:
        oneByte = uart.read(1)
        
        if oneByte == EOL_R:
            return buffer
        else:
            buffer += oneByte.decode()

def writeLine(buffer):
    buffer += EOL_W
    uart.write(buffer)
    
def setup():
    global uart
    
    uart = Uart()
    writeLine("Starting...")

def loop():
    cmd = readLine()
    writeLine(cmd)
        
def main():
    setup()
    while True:
        loop()
        sleep(0.01)
    
if __name__ == '__main__':
    main()
```

**실행**
- PC에는 입력한 문자열이 표시되지 않도록 -ni 옵션과 함께 실행
  ```sh
  xnode -p<포트번호> run -ni <스크립트파일명>
  ```

<br> 

---

<br>

## 스마트 홈 구현
- Auto 제어기의 릴레이에 연결된 환기팬, 조명, 도어락 제어
- PC 시리얼 스크립트를 작성해 Auto 제어기 제어

### Auto 제어기 스크립트
- PC에서 줄 단위 문자열 명령을 전송하면 Auto 제어기는 Uart로 이를 수신한 후 해당 작업 수행
  - Auto 제어기의 각 릴레이 채널에 연결된 GPIO 번호를 Pin 클래스로 제어하면 Auto 제어기에 연결된 환기 팬, 조명, 도어락 제어 가능
  - 릴레이 채널 1, 2, 3은 각각 GPIO 'D0', 'D6', D5'에 연결됨
- 문자열 데이터 형식 정의
  - <명령> [옵션]
    - fan 명령 
      - on 또는 off 옵션에 따라 환기팬 켜고 끄기
    - light 명령
      - on 또는 off 옵션에 따라 조명 켜고 끄기
    - doorlock 명령
      - 옵션은 없으며, 도어락 이벤트 생성 
- 예외 처리
  - 명령 또는 옵션이 형식에 벗어나면 오류 메시지 송신  

<details>
<summary>전체 코드</summary>

```python
#--------------------------------------------------------
# UART 
#--------------------------------------------------------
from pop import Uart

EOL_R = b'\r'
uart = Uart()

def readLine():
    buffer = ""
    
    while True:
        oneByte = uart.read(1)
        
        if oneByte == EOL_R:
            return buffer
        else:
            buffer += oneByte.decode()

def writeLine(buffer):
    uart.write(buffer + '\n')

#--------------------------------------------------------
# USER CODE 
#--------------------------------------------------------
from time import sleep
from machine import Pin

doorlock = None
light = None
fan = None

def setup():
    global doorlock, light, fan
    
    uart = Uart()
    writeLine("Starting...")
    
    doorlock = Pin('D0', Pin.OUT, value=0)    #릴레이 채널1 ('D0')
    light = Pin('D6', Pin.OUT, value=0)       #릴레이 채널2 ('D6')
    fan = Pin('D5', Pin.OUT, value=0)         #릴레이 채널3 ('D5')

def loop():
    cmd = readLine().lower().split(" ")
            
    if cmd[0] == "fan":
        if  len(cmd) == 2:
            if cmd[1] == "on":
                fan.on()
            elif cmd[1] == "off":
                fan.off()
            else:
                writeLine("Unknown option")
        else:
            writeLine("Unknown command")
    elif cmd[0] == "light":
        if len(cmd) == 2:
            if cmd[1] == "on":
                light.on()
            elif cmd[1] == "off":
                light.off()
            else:
                writeLine("Unknown option")
        else:
            writeLine("Unknown command")
    elif cmd[0] == "doorlock":
        if len(cmd) == 1:
            doorlock.on()
            sleep(0.5)
            doorlock.off()
        else:
            writeLine("Unknown option")
    else:
        writeLine("Unknown command")

#--------------------------------------------------------
# MAIN 
#--------------------------------------------------------        
def main():
    setup()
    while True:
        loop()
        sleep(0.01)
    
if __name__ == '__main__':
    main()
```
</details>

**실행**
- PC에서 줄 단위 문자열 명령을 전하면 Auto 제어기는 해당 제어 수행
  ```sh
  xnode -p<포트번호> run -i <스크립트파일명>
  ```
    
**다음 질문에 답하시오.**
- PC에서 \<ENTER\>로 끝나는 문자열을 Auto 제어기에 전송할 때 다음 동작에 대해 답하시오.
  - fan on 문자열 전송 결과는?
  - light on 문자열 전송 결과는?
  - doorlock 문자열 전송 결과는?
  - 환기팬을 끄려면 어떤 명령을 전송해야 하는가?
  - 조명을 끄려면 어떤 명령을 전송해야 하는가?
- setup() 함수에서 다음 코드의 의미는 무엇인가?
  ```python
  fan = Pin('D5', Pin.OUT, value=0)
  light = Pin('D6', Pin.OUT, value=0)
  doorlock = Pin('D0', Pin.OUT, value=0)
  ```
- loop() 함수에서 다음 코드의 의미는 무엇인가?
  ```python
  cmd = readLine().lower().split(" ")
  ```
- loop() 함수에 포함된 다음 선택 구조의 의미를 설명하시오.
  ```python
  if <조건>:
     <명령1>
  else:
     <명령2>
  ```
  ```python
  if <조건1>:
      <명령1>
  elif <조건2>:
      <명령2>
  else:
      <명령3>
  ```    

### PC 스크립트
- PC 시리얼 포트를 제어하는 PySerial 라이브러리 사용 (xnode 라이브러리 설치 과정에서 자동 설치됨)
  ```sh
  pip install pyserial
  ```
  - Serial 객체를 만들 때 포트번호, 전송속도(Auto 제어기는 115200 사용) 등으로 포트 열기
  - read(), write() 등으로 데이터 읽고 쓰기
  - 종료할 때 close()를 호출해 열린 포트 닫기
- 1초 마다 차례로 환기팬 켜기, 환기팬 끄기, 조명 켜기, 조명 끄기, 도어락 이벤트 발생 후 종료
<details>
<summary>전체 코드</summary>

```python
from serial import Serial
from time import sleep

PORT = "COM10" #자신의 포트 번호로 변경

def main():
    ser = Serial(PORT, 115200, timeout=0)
    print("PC Starting...")
    sleep(1)

    ser.write("fan on\r".encode())
    sleep(1)
    ser.write("fan off\r".encode())
    sleep(1)

    ser.write("light on\r".encode())
    sleep(1)
    ser.write("light off\r".encode())
    sleep(1)
    
    ser.write("doorlock\r".encode())
    sleep(1)

    ser.close()
    
if __name__ == "__main__":
    main()
```
</details>

**실행**
1. Auto 제어기 스크립트를 다음과 같이 실행
  ```sh
  xnode -p<포트번호> run -n <스크립트파일명>
  ```
  
2. PC 스크립트를 다음과 같이 실행
  ```sh
  python <스크립트파일명>
  ```

### 기능 추가
- all 명령과 on, off 옵션으로 환기팬과 조명, 도어락을 모두 켜고 끄는 기능을 추가해 보시오.
  - Auto 제어기 스트립트에 all on, all off 조건 추가
    ```python
    elif cmd[0] == "all":
        pass #이곳에 기능 구현       
    ```
  - PC 스크립트에 all on, all off 테스트 코드 추가  
    ```python
    ser.write("all on\r".encode())
    sleep(1)
    ser.write("all off\r".encode())
    sleep(1)
    ```

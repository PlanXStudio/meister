# XNode Home
IoT 센서가 부착된 장비는 온도, 습도, 압력, 진동 등 다양한 데이터를 실시간으로 수집하여 전송하며, 이렇게 수집된 데이터를 분석함으로써 생산 공정의 효율성을 극대화하고 불량률을 감소시키며 생산량을 최적화할 수 있습니다.   
또한, IoT 데이터 기반의 공정 자동화를 통해 특정 조건 충족 시 기계의 자동 작동 또는 정지 설정이 가능해져 인적 오류를 줄이고 생산 속도를 향상시킬 수 있으며, 장비 상태를 실시간으로 모니터링하여 고장을 사전에 예측하고 예방함으로써 장비 수명 연장 및 갑작스러운 고장으로 인한 생산 차질을 최소화합니다.

산업별 IoT 기술 적용 사례는 다음과 같습니다.

- 제조업: 스마트 팩토리 구축을 통해 생산 공정의 효율성을 극대화하고, 불량률을 최소화하며, 생산성 향상
- 에너지 산업: 스마트 그리드를 구축하여 에너지 효율을 높이고, 전력 공급의 안정성 향상 
- 물류 산업: 물류 추적 및 관리를 자동화하여 물류 효율성을 높이고, 배송 시간 단축
- 농업: 스마트 팜을 구축하여 작물의 생육 환경을 최적화하고, 생산량 증대

##  구성
XNode Home은 가정, 사무실, 공장 등에 설치된 인터넷 기반 자동 설비 제어에 필요한 소프트웨어 기술 학습을 위한 플랫폼입니다. IoT 모트(mote)와 IoT 모트가 내장된 자동 제어기, 전원 공급 장치 및 주변 장치 등으로 구성됩니다.  

### IoT 모트
IoT 모트는 먼지(mote)라는 단어에서 유래했으며, 작고 분산된 무선 센서 노드를 지칭하는 용어로 널리 사용됩니다. 따라서 무선 센서 네트워크(WSN) 또는 사물 인터넷(IoT) 환경에서 데이터를 수집하고 전송하는 데 사용되는 작은 장치라고 할 수 있습니다  
대표적인 무선 저전력 IoT 통신 기술이 내장된 저전력 MCU(Microcontroller Unit)와 배터리, 기본 센서, 확장 포트로 구성되며, 프로그래밍 언어는 파이썬의 하위 집합인 마이크로파이썬을 사용합니다.

다음은 IoT 모트의 구성입니다.

- Zigbee와 BLE 무선 통신 기술이 내장된 Silicon Labs의 Cortex M4 MCU 사용
- XBee의 Zigbee V3 및 BLE 소프트웨어 스택 탑재
- LiPo 타입 3.7V 내장 배터리로 운영
- USB B 타입 포트를 통해 배터리를 충전하거나 PC와 통신
- 공급 전압 측정(Battery)을 비롯해 조도(Bright), 온도/기압/습도/유기화합물(Tphg) 측정 센서 내장
- 전원 켜짐과 배터리 충전 중을 표시하는 LED와 사용자 정의 LED 내장
- 전원 스위치 및 리셋 버튼 내장
- 전용 26핀 확장 커넥터로 기능을 확장하는 추가 모듈 지원
  
### Auto 제어기
IoT 모트로 제어하는 Auto 제어기는 산업용 액추에이터나 센서 장치를 연결할 수 있도록 릴레이, PWM 컨트롤러, IO 포트로 구성됩니다. 릴레이에는 12V 조명이나 환풍기 등을 연결하고, PWM 컨트롤러에는 12V 조명이나 DC 모터를 연결하여 밝기 또는 속도를 조절합니다. IO 포트에는 3.3V 스위치나 센서 등을 연결합니다. 
Auto 제어기에 포함된 IoT 모트는 외부 전원을 사용하므로 전원 스위치 조작이 필요 없고, 필요에 따라 리셋 버튼만 사용합니다.  

다음은 Auto 제어기에서 IoT 모트를 제외한 추가 구성입니다.

- 12V 전원 어댑터로 동작
- IoT 모트의 IO 라인과 전원으로 구성된 터미널 블록 제공
  - IO 포트에는 3V3으로 운영되는 입출력 장치 연결
  - 전원 포트는 3V3, 5V, 12V, GND으로 구성
    - 전원선을 잘못 연결할 경우 **장비가 파손될 수 있으므로** 각별히 주의 
- 전원을 사용하는 토글 형태의 외부 장치(조명, 환기팬 등)를 연결할 수 있도록 3채널 A접점(normmal open) 릴레이용 터미널 블록 제공
  - 2.54mm 2핀 점퍼 쇼트 커넥터를 통해 해당 채널의 공용(command) 단자에 내부 12V 또는 5V 전원 공급 또는 공급하지 않음 선택
  - 제품 출고 시 1번 채널의 공통 단자는 전원에 연결되어 있지 않으며, 2번과 3번 채널의 공통 단자는 내부 12V 전원에 연결되어 있음
- 4채널 PWM 컨트롤러에 연결하여 최대 2kHz 주파수의 12V PWM 신호를 출력할 수 있는 터미널 블록을 제공
  - 4개의 PWM 채널 단자와 함께 12V 전원 및 GND 단자 포함

### 전원 공급기
- 12V DC 전원 입력을 최대 3개의 12V DC 전원 출력으로 공급
- 2x16 텍스트LED 내장
- 부가 기능으로 XNode의 하드웨어 인터페이스에 연결된 포트 제공
  - 다양한 전원 (3V3, 5V, 12V, GND) 포트 제공

### 확장 모듈
- XNode 모트의 확장 포트에 연결해 사용
- 관성 센서(IMU), 비접촉 적외선온도 센서(IRDA), 움직임감지 센서(PIR), 범지구측위 센서(GPS), 기본 IO 장치(LED, 버튼, 부저)  

### Auto 제어기 주변장치
- Auto 제어기의 릴레이 및 IO 포트에 연결해 사용
- 전원선(12V): 팬(FAN), 조명(Light), 가스 잠금 장치(Gas Circuit Breaker)
- 신호선: 도어락(DoorLock), 가스 감지기(Gas Detector)

## 실습 환경
PC에 xnode 툴을 설치한 후 XNode 모트 또는 Auto 제어기 (이하 실습장비)에서 실행할 마이크로파이썬 코드를 작성한 후 실습장치에서 실행  
시리얼 통신을 통해 실습장치와 협업하는 PC용 파이썬 코드 작성을 위해 PC에는 파이썬 SDK가 설치되어 있어야 함.  

실습장치(마이크로파이썬, xnode 라이브러리) <-----시리얼통신------> PC (VSCode, 파이썬 SDK, xnode 툴 등)

### XNode 모트
- 한 개의 XNode 모트 사용
  - XNode 모트의 Micro B 포트와 PC의 USB A 포토를 USB 케이블로 연결
    - 만약 PC에 Type C 포트만 제공하면 Type C to USB A 변환기를 별도 준비해야 함
  - PC에서 XNode 모트의 시리얼 포트 확인 
- 여러 개의 XNode 모트 사용
  - 5V USB 허브용 전원 어댑터를 USB 허브에 연결한 후 전용 케이블로 PC(USB 3.0 A 포트)와 USB 허브(USB 3.0 MicroB 포트) 연결.
    - USB 허브의 USB A 포트에 여러 개의 XNode 모트 연결  
  - PC에서 여러 Auto 제어기의 시리얼 포트 확인
    - XNode 모트를 하나씩 연결하면서 확인할 것

### Auto 제어기 
- 한 개의 Auto 제어기 사용
  - 12V DC 전원 입력을 Auto 제어기 전원 포트에 연결
  - Auto 제어기의 Micro B 포트와 PC의 USB A 포토를 USB 케이블로 연결
    - 만약 PC에 Type C 포트만 제공하면 Type C to USB A 변환기를 별도 준비해야 함
  - PC에서 Auto 제어기의 시리얼 포트 확인 
- 여러 개의 Auto 제어기 사용
  - 5V USB 허브용 전원 어댑터를 USB 허브에 연결한 후 전용 케이블로 PC(USB 3.0 A 포트)와 USB 허브(USB 3.0 MicroB 포트) 연결.
    - USB 허브의 USB A 포트에 여러 개의 Auto 제어기 연결  
  - 12V DC 전원 입력을 전공 공급기에 연결한 후 전용 케이블을 각각의 Auto 제어기 전원 포트에 연결
  - PC에서 여러 Auto 제어기의 시리얼 포트 확인
    - Auto 제어기를 하나씩 연결하면서 확인할 것

### 개발 툴 설치
xnode와 micropython-magic을 비롯해 실습에 필요한 툴 설치.

**xnode**
xnode는 실습장치 초기화를 비롯해 PC에서 작성한 마이크로파이썬 파일을 실습장치로 전송해 실행하거, 실행 중인 프로그램과 시리얼 통신을 수행하며, 실습장치의 파일 관리 같은 부가 기능 수행.  

```sh
pip install -U xnode
pip install -U genlib s2u quat3d smon
```

**micropython-magic** 
micropython-magic은 주피터 노트북 환경에서 실시간으로 마이크로파이썬 코드를 셀 단위로 실습장치로 전송해 실행해 줌.
주로 실습장비를 테스트하거나 특정 함수나 클래스의 사용법을 익힐 때 사용

```sh
pip install -U micropython-magic
```

## 시작하기
실습장비를 PC에 연결한 후 VSCode와 xnote 툴을 이용해 실습 진행

1. scan 명령으로 PC에 연결된 실습장비의 시리얼 포트 확인
   > - **실습 장비가 바뀔 때마다 확인**할 것! (com4로 가정)
```sh
xnode scan
```

- 만약 시리얼 포트가 여러개 출력되면 다음과 같이 장치 관리자를 실행한 후 **포트(COM & LPT) > USB Serial PortI(COMx)** 확인
```
devmgmt.msc 
```

2. init 명령으로 처음 사용하는 실습장비 초기화(포맷 및 전용 라이브러리 설치)
   > 해당 장비당 한 번만 수행하며,약 2분정도 소요됨
```sh
xnode --sport com4 init
```

3. ls 명령으로 전용 라이브러리(xnode/pop) 설치 확인
   > /flash/lib 경로에 라이브러리 위치  
```sh
xnode --sport com4 ls /flash/lib/xnode/pop
```

4. VSCode에서 새 파이썬 파일(my.py)을 만든 후 코드 작성
   > PC에서 계산 가능한 식을 시리얼 통신으로 실습장비에 전달하면 실습장비는 이를 계산한 결과를 다시 PC로 전송 
```python
def setup():
    print("Start...")

def loop():
    exp = input("> ")
    try:
        ret = eval(exp)
        print(ret)
    except:
        print("Syntax Error")

if __name__ == "__main__":
    setup()
    while True:
        loop()
```

- 마이크로파이썬에서 input()은 시리얼로부터 문자열 데이터 읽기, print()는 출력할 문자열을 시리얼로 전송

5. 작성한 코드는 run 명령으로 실습장비에 전송해 실행
   > xnode 툴이 실습장비와 시리얼 통신 수행.  
   >> 사용자가 PC 터미널에서 입력한 문자열을 실습장비로 전송하고, 실습장비가 전송한 문자열을 읽어 화면에 표시

```sh
xnode --sport com4 run my.py
```
- 프로그램이 무한 루프일 때 터미널에서 Ctrl+c를 누르면 xnode 툴은 종료하지만, 프로그램은 계속 실행됨.
  - 실습장비의 리셋 버튼을 누르면, 실행 중인 프로그램 강제 종료

6. run과 함께 -ni(또는 -in)을 사용하면 에코 기능이 꺼지므로 입력 문자가 중복 출력되지 않음
```sh
xnode --sport com4 run -ni my.py
```

7. run과 함께 -n을 사용하면 파이썬 코드를 실습장비에서 실행한 후 바로 xnode 툴 종료
```sh
xnode --sport com4 run -n my.py
```

8. xnode 툴 대신 PuTTY와 같은 시리얼 응용프로그램 사용
   > 앞서 실행한 프로그램 테스트 진행
```py
winget install PuTTY.PuTTY
```
- [주의] **xnode 툴과 putty는 동시에 실행할 수 없으므로** 반드시 xnode 툴은 종료 상태여야 함
- 설치가 완료되면 putty를 실행한 후 다음과 같이 설정
  - Connection type: Serial
  - Serial line: COMx,
  - Speed는 115200
  - Open 버튼 클릭

9. put 명령으로 PC에서 작성한 my.py를 main.py란 이름으로 바꿔 실습장비에 옮기기
   > 실습장비에 전원이 공급(또는 리셋)되면, /flash 폴더에 main.py가 있는지 검사 후 있으면 자동으로 실행

```sh
xnode --sport com4 put my.py /flash/main.py
xnode --sport com4 ls /flash
```  

- 앞서 설치한 PuTTY로 결과 확인

10. 실습장치의 파일시스템에 위치한 파일을 rm 명령으로 삭제하기
    > 앞서 옮긴 /flash/main.py 삭제
```sh
xnode --sport com4 rm /flash/main.py
xnode --sport com4 ls /flash
```
